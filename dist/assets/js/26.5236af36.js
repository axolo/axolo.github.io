(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{390:function(t,s,a){t.exports=a.p+"assets/img/sql-antipatterns.5c58d240.jpg"},451:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"读《sql反模式》"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#读《sql反模式》"}},[t._v("#")]),t._v(" 读《SQL反模式》")]),t._v(" "),n("h2",{attrs:{id:"缘起"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缘起"}},[t._v("#")]),t._v(" 缘起")]),t._v(" "),n("p",[t._v("逛知乎偶遇阿里云数据工程师张友东的"),n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/36831350",target:"_blank",rel:"noopener noreferrer"}},[t._v("《SQL反模式：SQL 建模与使用指南》"),n("OutboundLink")],1),t._v("，力荐《SQL反模式》。于是，顺便也花几个小时刷了这本书。读到一半的时候，狂妄的认为自己差不多可以写一本 "),n("strong",[t._v("《反〈SQL反模式〉》")]),t._v(" 了，一时兴起便有了这篇读书笔记。原著中列出的反模式基本上涵盖了开发中常见的问题，虽说由于成书较早，解决方案不算尽善尽美，但即便如此也是前车之鉴，后车之师，有则改之，无则加勉，安全生产，警钟长鸣。")]),t._v(" "),n("h2",{attrs:{id:"一、原著封面"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、原著封面"}},[t._v("#")]),t._v(" 一、原著封面")]),t._v(" "),n("p",[n("img",{attrs:{src:a(390),alt:"封面"}})]),t._v(" "),n("h2",{attrs:{id:"二、乱穿马路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、乱穿马路"}},[t._v("#")]),t._v(" 二、乱穿马路")]),t._v(" "),n("h3",{attrs:{id:"目的：存储多值属性（1nf）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：存储多值属性（1nf）"}},[t._v("#")]),t._v(" 目的：存储多值属性（1NF）")]),t._v(" "),n("p",[t._v("一个产品可以拥有多个作者，且在数据结构设计上应该符合1NF。")]),t._v(" "),n("h3",{attrs:{id:"反模式：格式化的逗号分隔列表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：格式化的逗号分隔列表"}},[t._v("#")]),t._v(" 反模式：格式化的逗号分隔列表")]),t._v(" "),n("p",[t._v("以下是一张不符合1NF的表格，用逗号分隔存储作者列表。由于"),n("code",[t._v("account_id")]),t._v("类型为"),n("code",[t._v("VARCHAR")]),t._v("，引发了长度不够、非作者ID、分隔符错误、查询统计困难、性能低下，等等一系列问题。")]),t._v(" "),n("ul",[n("li",[t._v("Prodcuts")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}},[t._v("product_id")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("product_name")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("account_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("blog")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("1,3")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("crm")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("1,2,4")])])])]),t._v(" "),n("h3",{attrs:{id:"解决方案：创建一张交叉表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：创建一张交叉表"}},[t._v("#")]),t._v(" 解决方案：创建一张交叉表")]),t._v(" "),n("p",[t._v("多值属性建议使用交叉表来存储，有利于CURD，避免不可信赖的用户输入。")]),t._v(" "),n("ul",[n("li",[t._v("ProductAccounts")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}},[t._v("product_id")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("account_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("1")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("3")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("1")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("2")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("4")])])])]),t._v(" "),n("h3",{attrs:{id:"感悟：oracle实现分隔符转多行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：oracle实现分隔符转多行"}},[t._v("#")]),t._v(" 感悟：Oracle实现分隔符转多行")]),t._v(" "),n("p",[t._v("逗号分隔的做法在一些非常老的系统里很常见。比如伯俊BOS2.0，或许因为存活年份实在太久，迭代需要考虑兼容性，其大量的构思、数据结构、算法简直是开发届的 "),n("strong",[t._v("经典反面案例")]),t._v(" 。存在的问题年代久远根深蒂固，错误的基础上已经堆积了很多高层建筑，联系千丝万缕，牵一发而动全身，一不小心就会轰然倒塌。若重构成符合规范，其代价不亚于全新重写一个，所以很多时候也只有姑息处理，一声长叹。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 伯俊BOS2.0采用Oracle数据库，其零售明细表")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 一条明细用一个字段存放数量不定的导购，其分成比例也是一个字段，都采用逗号分隔")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n  Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                                                                 "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 零售明细编号")]),t._v("\n  Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TOT_AMT_ACTUAL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                                                     "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 明细成交金额")]),t._v("\n  Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("QTY"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                                                                "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 明细成交数量")]),t._v("\n  REGEXP_SUBSTR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SALESREPS_ID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[^,]+'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" L"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SALESREPS_ID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("             "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 多个导购编号")]),t._v("\n  NVL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("REGEXP_SUBSTR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SALESREPS_RATE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[^,]+'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" L"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" SALESREPS_RATE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 多个分成比例")]),t._v("\n  L\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v("\n  M_RETAILITEM Z"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                                                       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 零售明细表")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("LEVEL")]),t._v(" L "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" DUAL "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CONNECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("LEVEL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 层级深度小于10")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br")])]),n("h2",{attrs:{id:"三、单纯的树"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、单纯的树"}},[t._v("#")]),t._v(" 三、单纯的树")]),t._v(" "),n("h3",{attrs:{id:"目的：分层存储与查询（cte）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：分层存储与查询（cte）"}},[t._v("#")]),t._v(" 目的：分层存储与查询（CTE）")]),t._v(" "),n("p",[t._v("由于《SQL反模式》成书在2011年，且默认使用的是MySQL，当时还不支持SQL-99标准的WITH语句和CTE递归查询。作者表示，虽然使用“邻接表”数据结构没问题，但递归查询实现困难，所以采用了“路径枚举”、“嵌套集”、“闭包表”等数据结构来实现。时至今日，目前的MySQL、MariaDB和主流数据库都支持CTE递归查询了。所以，简洁有效的解决方案是“邻接表”数据结构加“SQL公用表表达式(CTE)递归实现。CTE可以解决无限分类、族谱、目录、树、公交站点等等多个经典问题。")]),t._v(" "),n("h3",{attrs:{id:"反模式：总是依赖父节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：总是依赖父节点"}},[t._v("#")]),t._v(" 反模式：总是依赖父节点")]),t._v(" "),n("p",[t._v("一颗总是依赖父节点的树。")]),t._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("1、这个Bug的成因是什么（Fran）\n|-- 2、我觉得是一个空指针（Ollie）\n|   `-- 3、不，我查过了（Fran）\n`-- 4、我们需要查无效输入（Kukla）\n    |-- 5、是的，那是个问题（Ollie）\n    `-- 6、好，查一下吧（Fran）\n        `-- 7、解决了（Kukla）\n            `-- 8、非常棒（Fran）\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h3",{attrs:{id:"解决方案：邻接表-cte"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：邻接表-cte"}},[t._v("#")]),t._v(" 解决方案：邻接表 + CTE")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 表结构")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Comments "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  comment_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  parent_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  author "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  content "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 插入数据")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" Comments "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("comment_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parent_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" author"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" content"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Fran'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'这个Bug的成因是什么'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Ollie'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我觉得是一个空指针'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Fran'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'不，我查过了'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Kukla'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我们需要查无效输入'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Ollie'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'是的，那是个问题'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Fran'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'好，查一下吧'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Kukla'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'解决了'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Fran'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'非常棒'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 递归查找评论id为4的所有子评论")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WITH")]),t._v(" RECURSIVE cte "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Comments "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" comment_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 条件：评论id = 4")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNION")]),t._v("                                          "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 递归：父评论id为此评论id的评论")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Comments c "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" cte t "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("comment_id\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" cte"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br")])]),n("h3",{attrs:{id:"感悟：邻接表实现与转换"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：邻接表实现与转换"}},[t._v("#")]),t._v(" 感悟：邻接表实现与转换")]),t._v(" "),n("ul",[n("li",[t._v("实现："),n("a",{attrs:{href:"https://www.cnblogs.com/f-ck-need-u/p/8875863.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("MariaDB表达式：CTE"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("转换："),n("a",{attrs:{href:"https://github.com/yi-ge/js-tree-list",target:"_blank",rel:"noopener noreferrer"}},[t._v("js-tree-list"),n("OutboundLink")],1)])]),t._v(" "),n("h2",{attrs:{id:"四、需要id"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、需要id"}},[t._v("#")]),t._v(" 四、需要ID")]),t._v(" "),n("h3",{attrs:{id:"目的：建立主键规范（pk）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：建立主键规范（pk）"}},[t._v("#")]),t._v(" 目的：建立主键规范（PK）")]),t._v(" "),n("p",[t._v("这一章我就不多说了，一个联合主键（联合唯一）问题上纲上线了。其实主键命名为“id”没那么恐怖，仅仅因为可以使用“USING”？")]),t._v(" "),n("p",[t._v("问题并不是出在id，而是出在没有联合唯一，有点牵强附会，莫须有嘛。id表示，这个锅我还真不背。")]),t._v(" "),n("p",[t._v("尽信书则不如无书，千万别不加思索的照搬照抄。无则加勉，有则改之吧。正如作者说的： "),n("strong",[t._v("规则仅仅在它有帮助的时候才是好的")]),t._v(" 。")]),t._v(" "),n("h3",{attrs:{id:"反模式：以不变应万变"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：以不变应万变"}},[t._v("#")]),t._v(" 反模式：以不变应万变")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- bug_id、product_id没有唯一，当然可以出现重复值啦")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" BugProducts "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  id            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  bug_id        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  product_id    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h3",{attrs:{id:"解决方案：剪裁设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：剪裁设计"}},[t._v("#")]),t._v(" 解决方案：剪裁设计")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" BugProducts "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  product_id    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                 "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 放大招，此处应有掌声")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h3",{attrs:{id:"感悟：主键的选择与设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：主键的选择与设计"}},[t._v("#")]),t._v(" 感悟：主键的选择与设计")]),t._v(" "),n("ul",[n("li",[t._v("尽量使用逻辑主键，尽量避免使用业务主键。")]),t._v(" "),n("li",[t._v("若一定要使用业务主键必须保证业务逻辑不改变。比如手机做主键，一但换号，各种逻辑必须随之改变。")]),t._v(" "),n("li",[t._v("主键不能交由用户修改，特别是业务主键。")]),t._v(" "),n("li",[t._v("除交叉表外，尽量不使用复合主键。")]),t._v(" "),n("li",[t._v("分布式需要考虑使用uuid、uuid_short、Snowflake，而不仅仅是自增主键（可参考MongoDB的ObjectId）。")])]),t._v(" "),n("h2",{attrs:{id:"五、不用钥匙的入口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五、不用钥匙的入口"}},[t._v("#")]),t._v(" 五、不用钥匙的入口")]),t._v(" "),n("h3",{attrs:{id:"目的：简化数据库架构（fk）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：简化数据库架构（fk）"}},[t._v("#")]),t._v(" 目的：简化数据库架构（FK）")]),t._v(" "),n("p",[t._v("抛开剂量谈毒性，都是耍流氓。到底要不要用外键？不提前提条件和场景，单说啥需要或者不需要的，都是伪科学。")]),t._v(" "),n("ul",[n("li",[t._v("传统派需要注意，原著上的分条执行SQL的打时间差的碰瓷行为，完全属于误导。")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 分开执行")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" account_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Accounts "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" account_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reported_by"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("SQL难道不能使用子语句最大限度降低时间差的影响吗，何况还有锁行和事物机制？")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 子语句执行")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reported_by"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" account_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Accounts "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" account_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("ul",[n("li",[t._v("反对派也别高兴太早，如果场景属于小型应用而且非常注重安全性，你以外键同步更新和删除麻烦来拒绝，也是站不住脚的。难道你不知道外键有“ "),n("strong",[t._v("级联更新")]),t._v(" ”吗？")])]),t._v(" "),n("h3",{attrs:{id:"反模式：无视约束"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：无视约束"}},[t._v("#")]),t._v(" 反模式：无视约束")]),t._v(" "),n("ul",[n("li",[t._v("使用应用程序保证数据的完整性")]),t._v(" "),n("li",[t._v("不用外键时数据管理简单，操作方便，性能高")]),t._v(" "),n("li",[t._v("分布式部署（分库、分表），约束单纯靠数据库实现已力所难及")])]),t._v(" "),n("h3",{attrs:{id:"解决方案：声明约束"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：声明约束"}},[t._v("#")]),t._v(" 解决方案：声明约束")]),t._v(" "),n("ul",[n("li",[t._v("由数据库自身保证数据一致性，完整性，更可靠")]),t._v(" "),n("li",[t._v("有主外键的可以增加ER图的可读性，这点在数据库设计时非常重要")]),t._v(" "),n("li",[t._v("外键在一定程度上说明的业务逻辑，会使设计周到具体全面")])]),t._v(" "),n("h3",{attrs:{id:"感悟：安全-vs-性能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：安全-vs-性能"}},[t._v("#")]),t._v(" 感悟：安全 vs 性能")]),t._v(" "),n("ul",[n("li",[t._v("注重安全：使用外键，由数据库自身保证。适用于小型应用和注重安全的大中型应用。")]),t._v(" "),n("li",[t._v("注重性能：抛弃外键，由程序控制约束。适用于允许数据冗余和容错的大中型应用，比如互联网场景。")])]),t._v(" "),n("h2",{attrs:{id:"六、实体-属性-值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六、实体-属性-值"}},[t._v("#")]),t._v(" 六、实体-属性-值")]),t._v(" "),n("h3",{attrs:{id:"目的：支持可变属性（eav）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：支持可变属性（eav）"}},[t._v("#")]),t._v(" 目的：支持可变属性（EAV）")]),t._v(" "),n("p",[t._v("完美支持弹性可变属性基本算是伪命题，实际应用中却有大量这样的需求。\n究其原因，不外乎要么最初对需求分析过于粗放，没有深入到细节，很多本需弹性的需求却被固化了，到发现时为时已晚。")]),t._v(" "),n("h3",{attrs:{id:"反模式：使用泛型属性表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：使用泛型属性表"}},[t._v("#")]),t._v(" 反模式：使用泛型属性表")]),t._v(" "),n("p",[t._v("将EAV（实体-属性-值：类似于NoSQL的Key-Value）结构用在了关系型数据库。问题如下：")]),t._v(" "),n("ul",[n("li",[t._v("数据未定义类型，通常是字符类型的，通常需要转换后才能对比")]),t._v(" "),n("li",[t._v("不可靠的用户输入导致录入格式无法保证，因此数据无法转换")]),t._v(" "),n("li",[t._v("无法保证取值被正确约束，比如状态（Status）值超过规定范围")]),t._v(" "),n("li",[t._v("Key（attr_name）命名不一致，一义多名，导致问题")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" IssueAttributes "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  issue_id    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  attr_name   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  attr_value  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("issue_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attr_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("issue_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Issues"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("issue_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h3",{attrs:{id:"解决方案：模型化子类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：模型化子类型"}},[t._v("#")]),t._v(" 解决方案：模型化子类型")]),t._v(" "),n("ul",[n("li",[t._v("单表继承：多一个属性，就多创建一列呗，用不到的就空着。")]),t._v(" "),n("li",[t._v("实体表继承：公共的属性拎出来一张主表，不常用的属性加上公共属性另外搞一张表，另类的属性加公共属性再搞一张表，外键关联起来。")]),t._v(" "),n("li",[t._v("类表继承：公共的属性拎出来一张主表，不常用的属性每一个属性搞一张表存着，外键关联起来。")]),t._v(" "),n("li",[t._v("半结构化数据模型：把不常用属性存成JSON或者XML。（吐槽：真是美其名曰了，我想知道跟逗号有什么区别？难道存逗号就不是半结构化，存JSON就高大上了？）")])]),t._v(" "),n("h3",{attrs:{id:"感悟：以不变应万变"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：以不变应万变"}},[t._v("#")]),t._v(" 感悟：以不变应万变")]),t._v(" "),n("p",[t._v("可变属性基本算是一个伪命题，由于属性不确定性，每个属性搞一个字段是能解决数据类型问题，但是你确定要这样做？\n一张表一百个字段，用到的就几个，其他全空值？新来一属性，就让DBA"),n("code",[t._v("ALTER TABLE ADD COLUMN")]),t._v("一次？然后招呼程序员改代码？\n不是所有人都是DBA，也不是所有人都是程序员，普通的系统管理用户可能连基本的编程代码都不会，怎么办？\n个人认为，对付“千变万化”的指导思想是， "),n("strong",[t._v("存储结构不变")]),t._v(" ，数据爱怎么变怎么变，随他变。")]),t._v(" "),n("ol",[n("li",[t._v("使用Key-Value，分段存储，动态弹性存储属性，灵活性设计方案；")]),t._v(" "),n("li",[t._v("使用JSON（MySQL的字段已经全面支持JSON类型）或XML半结构化存储，整段存取，也算是Key-Value的变种；")]),t._v(" "),n("li",[t._v("使用特性表"),n("code",[t._v("Features")]),t._v("扩张，不同产品拥有多个特性表（前端表现为多个Tab页），按需迭代，对既有设计的影响尽量做到最小。")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 特性")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Features"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  feature_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  name       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNIQUE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("comment")]),t._v("    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 产品特性")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" ProductFeatures "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  product_id  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  feature_id  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" feature_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Products"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("product_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("feature_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Features"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("feature_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 当表名是变量，可采用存储过程实现，甚至可以使用循环")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@sql")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" concat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SELECT * FROM '")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" name "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" features "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" feature_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PREPARE")]),t._v(" stmt "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@sql")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXECUTE")]),t._v(" stmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br")])]),n("h2",{attrs:{id:"七、多态关联"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#七、多态关联"}},[t._v("#")]),t._v(" 七、多态关联")]),t._v(" "),n("h3",{attrs:{id:"目的：引用多个父表（1nf）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：引用多个父表（1nf）"}},[t._v("#")]),t._v(" 目的：引用多个父表（1NF）")]),t._v(" "),n("p",[t._v("Comments（评论表）可能被Bugs（错误表）和特性表（Features）同时用到。\n其实原著中有一句话我非常赞同： "),n("strong",[t._v("当你看清楚问题的根源时，解决方案将变得异常简单：多态关联是一个反向关联。")])]),t._v(" "),n("h3",{attrs:{id:"反模式：使用双用途外键"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：使用双用途外键"}},[t._v("#")]),t._v(" 反模式：使用双用途外键")]),t._v(" "),n("p",[t._v("Comments里面多了个type字段说明是评论来自Bugs还是来自Features的。就像一个孩子有两个父亲。")]),t._v(" "),n("ul",[n("li",[t._v("Bugs")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("bug_id")]),t._v(" "),n("th",[t._v("product_id")]),t._v(" "),n("th",[t._v("name")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("产品拥有多个作者")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("评论需要分层")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("2")]),t._v(" "),n("td",[t._v("根据关键字统计引用量出错")])])])]),t._v(" "),n("ul",[n("li",[t._v("Features")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("feature_id")]),t._v(" "),n("th",[t._v("product_id")]),t._v(" "),n("th",[t._v("name")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("完美支持多作者")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("树形多层评论")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("2")]),t._v(" "),n("td",[t._v("支持关键字统计")])])])]),t._v(" "),n("ul",[n("li",[t._v("Comments")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("comment_id")]),t._v(" "),n("th",[t._v("issue_type")]),t._v(" "),n("th",[t._v("issue_id")]),t._v(" "),n("th",[t._v("comment")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("bug")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("bug 1")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("feature")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("feture 1")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("bug")]),t._v(" "),n("td",[t._v("2")]),t._v(" "),n("td",[t._v("bug 2")])])])]),t._v(" "),n("h3",{attrs:{id:"解决方案：让关系变得简单"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：让关系变得简单"}},[t._v("#")]),t._v(" 解决方案：让关系变得简单")]),t._v(" "),n("p",[t._v("使用交叉表。")]),t._v(" "),n("ul",[n("li",[t._v("Bugs（同上）")]),t._v(" "),n("li",[t._v("Featrues（同上）")]),t._v(" "),n("li",[t._v("Commnets（变为基础表，不再关联其他表）")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("comment_id")]),t._v(" "),n("th",[t._v("parent_id")]),t._v(" "),n("th",[t._v("commnet")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("null")]),t._v(" "),n("td",[t._v("bug 1")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("null")]),t._v(" "),n("td",[t._v("feature 1")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("re bug 1")])])])]),t._v(" "),n("ul",[n("li",[t._v("BugsComments（交叉表）")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("bug_id")]),t._v(" "),n("th",[t._v("comment_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("1")])])])]),t._v(" "),n("ul",[n("li",[t._v("FeatruesComments（交叉表）")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("feature_id")]),t._v(" "),n("th",[t._v("comment_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("2")])])])]),t._v(" "),n("h3",{attrs:{id:"感悟：投胎很重要，看清楚谁是你爸！"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：投胎很重要，看清楚谁是你爸！"}},[t._v("#")]),t._v(" 感悟：投胎很重要，看清楚谁是你爸！")]),t._v(" "),n("p",[t._v("说白了，就是一个父亲有两亲生孩子正常，一孩子有两个亲生父亲？要不要打听一下隔壁是不是姓王？\n所以，评论表才是父亲，错误评论和特性评论表才是孩子。可怜的娃，认子作父！")]),t._v(" "),n("p",[t._v("同样的，我见过很多设计，在规划附件表（Attachments）的时候犯同样的错误，总以为附件从属于文章（插图等），附件从属于产品（说明书等），附件从属于门店（照片等）。\n重度耦合，导致同一份文件副本被存储多次，文件存储系统管理混乱，臃肿不堪，无法去重。说实话，别再认贼作父了，附件才是真正的老子。")]),t._v(" "),n("h2",{attrs:{id:"八、多列属性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#八、多列属性"}},[t._v("#")]),t._v(" 八、多列属性")]),t._v(" "),n("h3",{attrs:{id:"目的：存储多值属性（又是1nf）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：存储多值属性（又是1nf）"}},[t._v("#")]),t._v(" 目的：存储多值属性（又是1NF）")]),t._v(" "),n("p",[t._v("给Bugs打标签，一个Bugs有多个标签。")]),t._v(" "),n("h3",{attrs:{id:"反模式：创建多个列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：创建多个列"}},[t._v("#")]),t._v(" 反模式：创建多个列")]),t._v(" "),n("p",[t._v("创建多个tag列，你能确保一个Bugs最多只能有三个标签？假如最多有100个，tag100？")]),t._v(" "),n("ul",[n("li",[t._v("Bugs")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("bug_id")]),t._v(" "),n("th",[t._v("description")]),t._v(" "),n("th",[t._v("tag1")]),t._v(" "),n("th",[t._v("tag2")]),t._v(" "),n("th",[t._v("tag3")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("保存时崩溃")]),t._v(" "),n("td",[t._v("crash")]),t._v(" "),n("td",[t._v("null")]),t._v(" "),n("td",[t._v("null")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("打印输出缓慢")]),t._v(" "),n("td",[t._v("printing")]),t._v(" "),n("td",[t._v("preformance")]),t._v(" "),n("td",[t._v("null")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("需要支持XML")]),t._v(" "),n("td",[t._v("null")]),t._v(" "),n("td",[t._v("null")]),t._v(" "),n("td",[t._v("null")])])])]),t._v(" "),n("h3",{attrs:{id:"解决方案：创建从属表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：创建从属表"}},[t._v("#")]),t._v(" 解决方案：创建从属表")]),t._v(" "),n("ul",[n("li",[t._v("Bugs")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("bug_id")]),t._v(" "),n("th",[t._v("description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("保存时崩溃")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("打印输出缓慢")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("需要支持XML")])])])]),t._v(" "),n("ul",[n("li",[t._v("Tags")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("tag_id")]),t._v(" "),n("th",[t._v("name")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("crash")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("printing")])]),t._v(" "),n("tr",[n("td",[t._v("3")]),t._v(" "),n("td",[t._v("preformance")])])])]),t._v(" "),n("ul",[n("li",[t._v("BugsTags")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("bug_id")]),t._v(" "),n("th",[t._v("tag_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("1")]),t._v(" "),n("td",[t._v("1")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("2")])]),t._v(" "),n("tr",[n("td",[t._v("2")]),t._v(" "),n("td",[t._v("3")])])])]),t._v(" "),n("h3",{attrs:{id:"感悟：如此穷追不舍，1nf表示受够了！"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：如此穷追不舍，1nf表示受够了！"}},[t._v("#")]),t._v(" 感悟：如此穷追不舍，1NF表示受够了！")]),t._v(" "),n("p",[t._v("1NF这个问题又拿出来讲，作者真有点过分了，说逗号分隔是“乱穿马路”我忍了，然后又来了，把逗号改成多列，每列命名一下，说是“多列属性”，又拿来炒！这个真不能忍！")]),t._v(" "),n("h2",{attrs:{id:"九、元数据分裂"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#九、元数据分裂"}},[t._v("#")]),t._v(" 九、元数据分裂")]),t._v(" "),n("h3",{attrs:{id:"支持可扩展性（partition）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#支持可扩展性（partition）"}},[t._v("#")]),t._v(" 支持可扩展性（PARTITION）")]),t._v(" "),n("p",[t._v("数量极为庞大的时候，考虑到空间和性能，需要进行分表操作。但如果手动分表，由于没有自动化的系统逻辑联系，会造成数据唯一性、完整性、同步性、跨表查询等各种问题，以及创建新表，迁移业务导致业务暂停的问题。自动化、标准化的分表请参考数据表分区技术"),n("code",[t._v("PARTITION")]),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"反模式：克隆表与克隆列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：克隆表与克隆列"}},[t._v("#")]),t._v(" 反模式：克隆表与克隆列")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs_2007"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" date_reported "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* other columns*/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs_2008"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" date_reported "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* other columns*/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs_2009"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" date_reported "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* other columns*/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"解决方案：分区及标准化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：分区及标准化"}},[t._v("#")]),t._v(" 解决方案：分区及标准化")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  date_reported "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- other columns")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" PARTTION "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("HASH")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("YEAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("date_reported"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" PARTTIONS "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("h3",{attrs:{id:"感悟：前车之鉴，后车之师"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：前车之鉴，后车之师"}},[t._v("#")]),t._v(" 感悟：前车之鉴，后车之师")]),t._v(" "),n("p",[t._v("很多方案其实都是现成的，学会借鉴很重要。康庄大道通罗马，可惜有人偏偏钻进了死胡同。")]),t._v(" "),n("h2",{attrs:{id:"十、取整错误"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十、取整错误"}},[t._v("#")]),t._v(" 十、取整错误")]),t._v(" "),n("h3",{attrs:{id:"目的：使用小数取代整数（decimal"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：使用小数取代整数（decimal"}},[t._v("#")]),t._v(" 目的：使用小数取代整数（DECIMAL)")]),t._v(" "),n("p",[n("code",[t._v("IEEE 754")]),t._v("的浮点数精度问题会导致计算结果偏差。很多数据库引擎的"),n("code",[t._v("FLOAT")]),t._v("类型就是一个非精确值。")]),t._v(" "),n("h3",{attrs:{id:"反模式：使用float类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：使用float类型"}},[t._v("#")]),t._v(" 反模式：使用FLOAT类型")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 字段该加在哪张表？时薪难道常年不变？我就不吐槽了。")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALTER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COLUMN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("hour")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FLOAT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALTER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Accounts "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COLUMN")]),t._v(" hour_rate "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FLOAT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"解决方案：使用decimal类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：使用decimal类型"}},[t._v("#")]),t._v(" 解决方案：使用DECIMAL类型")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALTER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COLUMN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("hour")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DECIMAL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALTER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Accounts "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COLUMN")]),t._v(" hour_rate "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DECIMAL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h3",{attrs:{id:"感悟：float不可靠，地球人都知道"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：float不可靠，地球人都知道"}},[t._v("#")]),t._v(" 感悟：FLOAT不可靠，地球人都知道")]),t._v(" "),n("p",[t._v("其实也算是非数据库程序员经常会犯的错误，很多程序设计语言并没有"),n("code",[t._v("DECIMAL")]),t._v("类型，高精度计算需要用到数学库。\n比如"),n("code",[t._v("JavaScript")]),t._v("只有"),n("code",[t._v("number")]),t._v("类型，高精度计算需要用到"),n("a",{attrs:{href:"http://mathjs.org",target:"_blank",rel:"noopener noreferrer"}},[t._v("math.js"),n("OutboundLink")],1),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"十一、每日新花样"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十一、每日新花样"}},[t._v("#")]),t._v(" 十一、每日新花样")]),t._v(" "),n("h3",{attrs:{id:"目的：限定列的有效值（enum）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目的：限定列的有效值（enum）"}},[t._v("#")]),t._v(" 目的：限定列的有效值（ENUM）")]),t._v(" "),n("p",[t._v("Status（状态）取值必须有效。但是，Status取值却不是固定的，有可能会添加Status的值。")]),t._v(" "),n("h3",{attrs:{id:"反模式：在列定义上指定可选值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：在列定义上指定可选值"}},[t._v("#")]),t._v(" 反模式：在列定义上指定可选值")]),t._v(" "),n("p",[t._v("使用"),n("code",[t._v("CHECK")]),t._v("或者"),n("code",[t._v("ENUM")]),t._v("定义在列上，当要动态添加取值的时候，会导致要求DBA去修改数据结构。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- other columns")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENUM")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'NEW'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'IN PROGRESS'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'FIXED'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"解决方案：在数据中指定值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：在数据中指定值"}},[t._v("#")]),t._v(" 解决方案：在数据中指定值")]),t._v(" "),n("ul",[n("li",[t._v("BugsStatus")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" BugsStatus "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" BugsStatus "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'NEW'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'IN PROGRESS'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'FIXED'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])]),n("ul",[n("li",[t._v("Bugs")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- other columns")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" BugsStauts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CASCADE")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("h3",{attrs:{id:"感悟：慎用enum（枚举类型）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：慎用enum（枚举类型）"}},[t._v("#")]),t._v(" 感悟：慎用ENUM（枚举类型）")]),t._v(" "),n("p",[t._v("大多数SQL引擎并不支持枚举类型，除非固化不动，尽量慎用。增删改的时候需要专业人员使用DDL（数据库定义语言），而不是普通用户可以使用的DML（数据操纵语言）。")]),t._v(" "),n("h2",{attrs:{id:"十二、幽灵文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十二、幽灵文件"}},[t._v("#")]),t._v(" 十二、幽灵文件")]),t._v(" "),n("h3",{attrs:{id:"目标：存储图片或其他多媒体大文件（blob）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：存储图片或其他多媒体大文件（blob）"}},[t._v("#")]),t._v(" 目标：存储图片或其他多媒体大文件（BLOB）")]),t._v(" "),n("p",[t._v("这个问题见仁见智了，其实大量的做法是用"),n("code",[t._v("VARCHAR")]),t._v("存储文件路径，原著推荐使用"),n("code",[t._v("BLOB")]),t._v("二进制格式存储到数据库。你认为那种正确？我能告诉你都错了吗？")]),t._v(" "),n("h3",{attrs:{id:"反模式：假设你必须使用文件系统（也就是存储文件路径啦）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：假设你必须使用文件系统（也就是存储文件路径啦）"}},[t._v("#")]),t._v(" 反模式：假设你必须使用文件系统（也就是存储文件路径啦）")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Screenshots"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  image_id          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  screenshot_path   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  caption           "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" image_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("p",[t._v("原著列举了几大罪状：")]),t._v(" "),n("ul",[n("li",[t._v("文件不支持DELETE")]),t._v(" "),n("li",[t._v("文件不支持事物隔离")]),t._v(" "),n("li",[t._v("文件不支持回滚操作")]),t._v(" "),n("li",[t._v("文件不支持数据库备份工具")]),t._v(" "),n("li",[t._v("文件不支持SQL的访问权限设置")]),t._v(" "),n("li",[t._v("文件不是SQL数据类型")])]),t._v(" "),n("h3",{attrs:{id:"解决方案：在需要时使用blob类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：在需要时使用blob类型"}},[t._v("#")]),t._v(" 解决方案：在需要时使用BLOB类型")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Screenshots"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  image_id          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  screenshot_path   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BLOB")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  caption           "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" image_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("p",[t._v("其实反模式里面的罪状都可以用程序控制的办法解决。\n时至今日，静态内容使用分层存储更有甚者使用对象存储，是时候考虑一下问题了：")]),t._v(" "),n("ul",[n("li",[t._v("文件如何去重，特别是大文件？")]),t._v(" "),n("li",[t._v("流媒体文件如何在线播放？")]),t._v(" "),n("li",[t._v("动辄5G、10G的文件也要存BOLB吗？")]),t._v(" "),n("li",[t._v("不同的bug引用了同一份文件副本，有几份存几份BLOB么？")]),t._v(" "),n("li",[t._v("为了快速加载，要支持CDN，如何操作？")]),t._v(" "),n("li",[t._v("如何迁移到云存储？\n"),n("ul",[n("li",[n("a",{attrs:{href:"https://aws.amazon.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Amazon S3"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.aliyun.com/product/oss",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里云OSS"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://cloud.tencent.com/product/cos",target:"_blank",rel:"noopener noreferrer"}},[t._v("腾讯COS"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.qiniu.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("七牛云"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.firebase.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Firebase"),n("OutboundLink")],1)])])]),t._v(" "),n("li",[t._v("如何支持私有云？\n"),n("ul",[n("li",[n("a",{attrs:{href:"https://ceph.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ceph"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://www.seafile.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("SeaFile"),n("OutboundLink")],1)])])])]),t._v(" "),n("h3",{attrs:{id:"感悟：我说都错了，你信吗？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：我说都错了，你信吗？"}},[t._v("#")]),t._v(" 感悟：我说都错了，你信吗？")]),t._v(" "),n("ol",[n("li",[t._v("文件存储逐步从传统文件系统迁移到了对象存储服务。还在用BLOB存入数据库？就在记忆里画一个叉吧。")]),t._v(" "),n("li",[t._v("原著在数据结构设计上欠妥，主次关系混乱了。正如我在"),n("a",{attrs:{href:"#%E5%85%AD%E3%80%81%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94"}},[t._v("多态关联")]),t._v("中提到的，文件其实属于基类。以下为建议数据结构：")])]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" files "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  id          "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 文件HASH，文件名，一般是MD5")]),t._v("\n  mime        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 文件MIME，可计算为文件扩展名")]),t._v("\n  size        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 文件大小")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 无path？因为有buckets表和file_buckets表，二者结合解决存放位置问题")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" BugFiles "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  file_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BIGINT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNSIGNED")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" file_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOREIGN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REFERENCES")]),t._v(" files"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])]),n("h2",{attrs:{id:"十三、乱用索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十三、乱用索引"}},[t._v("#")]),t._v(" 十三、乱用索引")]),t._v(" "),n("h3",{attrs:{id:"目标：优化性能（index"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：优化性能（index"}},[t._v("#")]),t._v(" 目标：优化性能（INDEX)")]),t._v(" "),n("p",[t._v("改善性能最好的技术就是在数据库中合理的使用索引。")]),t._v(" "),n("h3",{attrs:{id:"反模式：无规划的使用索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：无规划的使用索引"}},[t._v("#")]),t._v(" 反模式：无规划的使用索引")]),t._v(" "),n("ul",[n("li",[t._v("无索引或者索引不足：导致历遍全表")]),t._v(" "),n("li",[t._v("使用了太多的索引或者使用了一些无效索引：导致不必要的额外开销")]),t._v(" "),n("li",[t._v("执行一些让索引无能为力的查询：根本没有用到索引")])]),t._v(" "),n("h3",{attrs:{id:"解决方案：mentor你的索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：mentor你的索引"}},[t._v("#")]),t._v(" 解决方案：MENTOR你的索引")]),t._v(" "),n("ul",[n("li",[t._v("Measure（测量）：查看“慢查询”日志")]),t._v(" "),n("li",[t._v("Explain（解释）：查询执行计划（QEP）")]),t._v(" "),n("li",[t._v("Nominate（挑选）：查询分析器")]),t._v(" "),n("li",[t._v("Test（测试）：把找出来的问题做相应测试")]),t._v(" "),n("li",[t._v("Optimize（优化）：优化索引性能")]),t._v(" "),n("li",[t._v("Rebuild（重建）：重建索引")])]),t._v(" "),n("h3",{attrs:{id:"感悟：合理利用数据查询分析工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：合理利用数据查询分析工具"}},[t._v("#")]),t._v(" 感悟：合理利用数据查询分析工具")]),t._v(" "),n("p",[t._v("没有索引翻箱倒柜，索引太多打草惊蛇。过犹不及，有和没有都会引起不必要的内耗，导致性能问题，合理的安排索引非常重要。")]),t._v(" "),n("h2",{attrs:{id:"十四、对未知的恐惧"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十四、对未知的恐惧"}},[t._v("#")]),t._v(" 十四、对未知的恐惧")]),t._v(" "),n("h3",{attrs:{id:"目标：辨别悬空值（null"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：辨别悬空值（null"}},[t._v("#")]),t._v(" 目标：辨别悬空值（NULL)")]),t._v(" "),n("p",[t._v("获取全名的时候，将中间名的列声明成了"),n("code",[t._v("NULL")]),t._v("，导致中间名为"),n("code",[t._v("NULL")]),t._v("的全名也成了"),n("code",[t._v("NULL")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" CONCAT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("first_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" middle_initial"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" last_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Accounts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- output: NULL")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h3",{attrs:{id:"反模式：将null作为普通的值，反之亦然"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：将null作为普通的值，反之亦然"}},[t._v("#")]),t._v(" 反模式：将NULL作为普通的值，反之亦然")]),t._v(" "),n("ul",[n("li",[t._v("将所有列一律声明为"),n("code",[t._v("NOT NULL")])]),t._v(" "),n("li",[t._v("列中的每一个值都必须存在且有意义的时候，却用了"),n("code",[t._v("NULL")])])]),t._v(" "),n("h3",{attrs:{id:"解决方案：将null视为特殊值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：将null视为特殊值"}},[t._v("#")]),t._v(" 解决方案：将NULL视为特殊值")]),t._v(" "),n("p",[t._v("值必须存在且有意义的时候，请务必声明为"),n("code",[t._v("NOT NULL")]),t._v("，可结合"),n("code",[t._v("DEFAULT")]),t._v("赋予默认值。")]),t._v(" "),n("h3",{attrs:{id:"感悟：null-or-not-null，that-is-the-question"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：null-or-not-null，that-is-the-question"}},[t._v("#")]),t._v(" 感悟：NULL or NOT NULL，that is the question")]),t._v(" "),n("ul",[n("li",[t._v("传统程序员："),n("code",[t._v("true")]),t._v("、"),n("code",[t._v("false")])]),t._v(" "),n("li",[t._v("数据库程序员："),n("code",[t._v("true")]),t._v("、"),n("code",[t._v("false")]),t._v("、"),n("code",[t._v("null")])]),t._v(" "),n("li",[t._v("JavaScript程序员："),n("code",[t._v("true")]),t._v("、"),n("code",[t._v("false")]),t._v("、"),n("code",[t._v("null")]),t._v("、"),n("code",[t._v("undefined")]),t._v("、"),n("code",[t._v("NaN")]),t._v("、"),n("code",[t._v("Infinity")]),t._v("、……")])]),t._v(" "),n("h2",{attrs:{id:"十五、模棱两可的分组"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十五、模棱两可的分组"}},[t._v("#")]),t._v(" 十五、模棱两可的分组")]),t._v(" "),n("h3",{attrs:{id:"目标：获取每组的最大值（group-by）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：获取每组的最大值（group-by）"}},[t._v("#")]),t._v(" 目标：获取每组的最大值（GROUP BY）")]),t._v(" "),n("p",[t._v("使用 "),n("code",[t._v("GROUP BY")]),t._v(" 获取正确的数据。")]),t._v(" "),n("ul",[n("li",[t._v("Bugs")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("product_name")]),t._v(" "),n("th",[t._v("date_reported")]),t._v(" "),n("th",[t._v("bug_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("Open RoundFile")]),t._v(" "),n("td",[t._v("2009-12-19")]),t._v(" "),n("td",[n("s",[t._v("1234")])])]),t._v(" "),n("tr",[n("td",[t._v("Open RoundFile")]),t._v(" "),n("td",[n("s",[t._v("2010-06-01")])]),t._v(" "),n("td",[t._v("2248")])]),t._v(" "),n("tr",[n("td",[t._v("Visual TurboBuilder")]),t._v(" "),n("td",[t._v("2010-02-16")]),t._v(" "),n("td",[t._v("3456")])]),t._v(" "),n("tr",[n("td",[t._v("Visual TurboBuilder")]),t._v(" "),n("td",[t._v("2010-02-10")]),t._v(" "),n("td",[t._v("4077")])]),t._v(" "),n("tr",[n("td",[t._v("Visual TurboBuilder")]),t._v(" "),n("td",[t._v("2010-02-16")]),t._v(" "),n("td",[t._v("5150")])]),t._v(" "),n("tr",[n("td",[t._v("ReConsider")]),t._v(" "),n("td",[t._v("2010-01-01")]),t._v(" "),n("td",[t._v("5678")])]),t._v(" "),n("tr",[n("td",[t._v("ReConsider")]),t._v(" "),n("td",[t._v("2009-11-09")]),t._v(" "),n("td",[t._v("8063")])])])]),t._v(" "),n("h3",{attrs:{id:"反模式：引用非分组列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：引用非分组列"}},[t._v("#")]),t._v(" 反模式：引用非分组列")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("date_reported"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" latest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bug_id\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" bugs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GROUP")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_name "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[t._v("结果如下：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("product_name")]),t._v(" "),n("th",[t._v("date_reported")]),t._v(" "),n("th",[t._v("bug_id")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("Open RoundFile")]),t._v(" "),n("td",[n("s",[t._v("2010-06-01")])]),t._v(" "),n("td",[n("s",[t._v("1234")])])]),t._v(" "),n("tr",[n("td",[t._v("Visual TurboBuilder")]),t._v(" "),n("td",[t._v("2010-02-16")]),t._v(" "),n("td",[t._v("3456")])]),t._v(" "),n("tr",[n("td",[t._v("ReConsider")]),t._v(" "),n("td",[t._v("2010-01-01")]),t._v(" "),n("td",[t._v("5678")])])])]),t._v(" "),n("ul",[n("li",[t._v("请注意第一行的"),n("code",[t._v("date_reported")]),t._v("与"),n("code",[t._v("bug_id")]),t._v("并不匹配，已用删除线标记")]),t._v(" "),n("li",[t._v("Visual TurboBuilder 其实有两行数据都是 2010-02-16 的")])]),t._v(" "),n("h3",{attrs:{id:"解决方法：无歧义的使用列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方法：无歧义的使用列"}},[t._v("#")]),t._v(" 解决方法：无歧义的使用列")]),t._v(" "),n("p",[t._v("原著给出的方案，我粗略看了一些，依然是问题重重：")]),t._v(" "),n("ul",[n("li",[t._v("只查询功能依赖的列product_name, max(date_reported)：我就要对应bug_id怎么办？")]),t._v(" "),n("li",[t._v("使用关联子查询：给出了相当复杂的SQL，有效性有待验证")]),t._v(" "),n("li",[t._v("使用衍生表：给出了相当复杂的SQL，有效性有待验证")]),t._v(" "),n("li",[t._v("使用JOIN：给出了相当复杂的SQL，有效性有待验证")]),t._v(" "),n("li",[t._v("对额外列使用聚合函数MAX(bug_id)：万一bug_id并不MAX呢？")]),t._v(" "),n("li",[t._v("连同组所有值，用"),n("code",[t._v("GROPU_CONCAT")]),t._v("连接成bug_id_list：说好的我只要对应的bug_id你给我一堆？")])]),t._v(" "),n("h3",{attrs:{id:"感悟：思维务必要清晰"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：思维务必要清晰"}},[t._v("#")]),t._v(" 感悟：思维务必要清晰")]),t._v(" "),n("p",[t._v("其实没那么复杂，使用聚合函数时思维务必要清晰，父子主次分清楚，否则一片混沌。上列解法如下，简单吧？")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" product_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" date_reported"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" bugs\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" date_reported "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("IN")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("date_reported"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" bugs b "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GROUP")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" product_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" date_reported "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DESC")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h2",{attrs:{id:"十六、随机选择"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十六、随机选择"}},[t._v("#")]),t._v(" 十六、随机选择")]),t._v(" "),n("h3",{attrs:{id:"目标：获取样本记录（rand）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：获取样本记录（rand）"}},[t._v("#")]),t._v(" 目标：获取样本记录（RAND）")]),t._v(" "),n("p",[t._v("从大量记录中获取一条随机记录。")]),t._v(" "),n("h3",{attrs:{id:"反模式：随机排序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：随机排序"}},[t._v("#")]),t._v(" 反模式：随机排序")]),t._v(" "),n("p",[t._v("著名的将"),n("code",[t._v("RAND()")]),t._v("放"),n("code",[t._v("ORDER BY")]),t._v("，历遍全表加重复扫描，性能不出问题才怪。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" RAND"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("LIMIT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h3",{attrs:{id:"解决方案：没有具体的顺序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：没有具体的顺序"}},[t._v("#")]),t._v(" 解决方案：没有具体的顺序")]),t._v(" "),n("p",[t._v("原著中给了很多方法，性能倒是改善了。我也不多做评价了，一句话，有必要搞这么复杂吗？")]),t._v(" "),n("h3",{attrs:{id:"感悟：简单点不好吗？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：简单点不好吗？"}},[t._v("#")]),t._v(" 感悟：简单点不好吗？")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Bugs\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" bug_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" FLOOR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("RAND"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("MAX")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bug_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Bugs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" bug_id "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("LIMIT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h2",{attrs:{id:"十七、可怜人的搜索引擎"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十七、可怜人的搜索引擎"}},[t._v("#")]),t._v(" 十七、可怜人的搜索引擎")]),t._v(" "),n("h3",{attrs:{id:"目标：全文搜索（fulltext）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：全文搜索（fulltext）"}},[t._v("#")]),t._v(" 目标：全文搜索（FULLTEXT）")]),t._v(" "),n("p",[t._v("通过关键字搜索字符串，通过字符串搜索全文。")]),t._v(" "),n("h3",{attrs:{id:"反模式：模式匹配断言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：模式匹配断言"}},[t._v("#")]),t._v(" 反模式：模式匹配断言")]),t._v(" "),n("p",[t._v("使用"),n("code",[t._v("LIKE")]),t._v("性能和效率都非常的低，大量数据全文检索的情况下速度实在令人无法接受。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" description "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("LIKE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%crash'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h3",{attrs:{id:"解决方案：使用正确的工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：使用正确的工具"}},[t._v("#")]),t._v(" 解决方案：使用正确的工具")]),t._v(" "),n("ul",[n("li",[t._v("添加全文索引：FULLTEXT（MySQL5.7开始支持ngram自然语言分词）")]),t._v(" "),n("li",[t._v("第三方搜索引擎：Apache Lucene、Sphinx Search（估计可以进博物馆了）")])]),t._v(" "),n("div",{staticClass:"language-ini line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ini"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# my.cnf")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[mysqld]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ngram_token_size")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("2")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" Bugs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  bug_id        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SERIAL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  description    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TEXT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- other columns,")]),t._v("\n  FULLTEXT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("description"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WITH")]),t._v(" PARSER ngram\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" bugs\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("MATCH")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("description"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" AGAINST "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'计算机'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h3",{attrs:{id:"感悟：中文全文检索"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：中文全文检索"}},[t._v("#")]),t._v(" 感悟：中文全文检索")]),t._v(" "),n("p",[t._v("从MySQL 5.7开始，MySQL内置了， "),n("strong",[t._v("ngram全文检索插件")]),t._v(" 支持中文分词，并且对MyISAM和InnoDB引擎有效。\n但实际应用上还是有或多或少的问题，比如著名的“杭州市长春药店”问题。")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://juejin.im/entry/5adb5deff265da0b9d77cb3b",target:"_blank",rel:"noopener noreferrer"}},[t._v("MySQL 8.0 安装踩坑指南"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/fulltext-search-ngram.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ngram全文检索插件"),n("OutboundLink")],1)])]),t._v(" "),n("h2",{attrs:{id:"十八、意大利面条式查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十八、意大利面条式查询"}},[t._v("#")]),t._v(" 十八、意大利面条式查询")]),t._v(" "),n("h3",{attrs:{id:"目标：减少sql查询数量（sql）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：减少sql查询数量（sql）"}},[t._v("#")]),t._v(" 目标：减少SQL查询数量（SQL）")]),t._v(" "),n("p",[t._v("如何正确、简单、高效完成复杂的SQL查询。")]),t._v(" "),n("h3",{attrs:{id:"反模式：使用一步操作解决复杂问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：使用一步操作解决复杂问题"}},[t._v("#")]),t._v(" 反模式：使用一步操作解决复杂问题")]),t._v(" "),n("p",[t._v("SQL开发人员常常仅用一句SQL查询完成一个复杂问题。")]),t._v(" "),n("h3",{attrs:{id:"解决方案：分而治之"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：分而治之"}},[t._v("#")]),t._v(" 解决方案：分而治之")]),t._v(" "),n("p",[t._v("尽管SQL支持用一行代码解决复杂问题，但也别做不切实际的事情。")]),t._v(" "),n("h3",{attrs:{id:"感悟：大道至简，把复杂变简单其实没那么简单"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：大道至简，把复杂变简单其实没那么简单"}},[t._v("#")]),t._v(" 感悟：大道至简，把复杂变简单其实没那么简单")]),t._v(" "),n("p",[t._v("常用的复杂的SQL查询，其实可以创建视图（VIEW）。")]),t._v(" "),n("h2",{attrs:{id:"十九、隐式的列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十九、隐式的列"}},[t._v("#")]),t._v(" 十九、隐式的列")]),t._v(" "),n("h3",{attrs:{id:"目标：减少输入（"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：减少输入（"}},[t._v("#")]),t._v(" 目标：减少输入（*)")]),t._v(" "),n("p",[t._v("描述为“获取正确的列”更妥当。")]),t._v(" "),n("h3",{attrs:{id:"反模式：捷径会让你迷失方向"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：捷径会让你迷失方向"}},[t._v("#")]),t._v(" 反模式：捷径会让你迷失方向")]),t._v(" "),n("p",[t._v("在非调试模式使用"),n("code",[t._v("*")]),t._v("，会带来很多的问题，比如列名覆盖、系统开销、安全隐患等等。")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- a.title = 书的标题、b.title = 作者的称呼")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 应用程序的 res.title = b.title，得不到正确的标题")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Books a "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" Authors b "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"解决方案：明确列出列名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：明确列出列名"}},[t._v("#")]),t._v(" 解决方案：明确列出列名")]),t._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("title"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("title author_title\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Books a\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" Authors b "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author_id "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("author_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"感悟：-是把双刃剑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：-是把双刃剑"}},[t._v("#")]),t._v(" 感悟："),n("code",[t._v("*")]),t._v("是把双刃剑")]),t._v(" "),n("p",[t._v("开发调试的时候可以快速排查，但非调试模式下尽量少用。")]),t._v(" "),n("h2",{attrs:{id:"二十、明文密码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十、明文密码"}},[t._v("#")]),t._v(" 二十、明文密码")]),t._v(" "),n("h3",{attrs:{id:"目标：恢复或重置密码（hash）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：恢复或重置密码（hash）"}},[t._v("#")]),t._v(" 目标：恢复或重置密码（HASH）")]),t._v(" "),n("p",[t._v("密码可以重置，但永远不能被提供或破解。")]),t._v(" "),n("h3",{attrs:{id:"反模式：使用明文存储密码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：使用明文存储密码"}},[t._v("#")]),t._v(" 反模式：使用明文存储密码")]),t._v(" "),n("p",[t._v("明文存储密码！居然还真有人这么干了！")]),t._v(" "),n("h3",{attrs:{id:"解决方案：先哈希，后存储"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：先哈希，后存储"}},[t._v("#")]),t._v(" 解决方案：先哈希，后存储")]),t._v(" "),n("p",[t._v("哈希安全字串加密码。")]),t._v(" "),n("h3",{attrs:{id:"感悟：天王盖地虎，宝塔镇河妖！"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：天王盖地虎，宝塔镇河妖！"}},[t._v("#")]),t._v(" 感悟：天王盖地虎，宝塔镇河妖！")]),t._v(" "),n("ul",[n("li",[t._v("蛮荒时代：明文，赤裸裸的明文。CSDN，你出来解释一下！")]),t._v(" "),n("li",[t._v("封建王朝："),n("code",[t._v("MD5")]),t._v("一下完事。这就完了？不知道MD5可以爆破吗？已知MD求明文，社工库笑了。")]),t._v(" "),n("li",[t._v("现代社会：后端哈希混淆后的"),n("code",[t._v("password")]),t._v("，前端再哈希"),n("code",[t._v("securit key")]),t._v("，前后端都不一致。")])]),t._v(" "),n("h2",{attrs:{id:"二十一、sql注入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十一、sql注入"}},[t._v("#")]),t._v(" 二十一、SQL注入")]),t._v(" "),n("h3",{attrs:{id:"目标：编写sql动态查询（injection）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：编写sql动态查询（injection）"}},[t._v("#")]),t._v(" 目标：编写SQL动态查询（Injection）")]),t._v(" "),n("p",[t._v("防范应用程序变量插入SQL查询中带来的安全问题。")]),t._v(" "),n("h3",{attrs:{id:"反模式：将未经验证的输入作为代码执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：将未经验证的输入作为代码执行"}},[t._v("#")]),t._v(" 反模式：将未经验证的输入作为代码执行")]),t._v(" "),n("div",{staticClass:"language-php line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{pre:!0,attrs:{class:"token php language-php"}},[n("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$bug_id")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_REQUEST")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'bug_id'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输入：1234; DELETE FROM Bugs;")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$pdo")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("query")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[t._v('"SELECT * FROM Bugs WHERE bug_id = '),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$bug_id")])]),t._v('"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("h3",{attrs:{id:"解决方案：不信任任何人"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：不信任任何人"}},[t._v("#")]),t._v(" 解决方案：不信任任何人")]),t._v(" "),n("p",[t._v("原著中就事论事的给出了解决方案，其实很多并不能解决注入问题：")]),t._v(" "),n("ul",[n("li",[t._v("过滤输入内容：转换为数字")]),t._v(" "),n("li",[t._v("参数化动态内容：使用SQL参数")]),t._v(" "),n("li",[t._v("给动态输入的值加引号：数字变成字符串")]),t._v(" "),n("li",[t._v("将用户与代码隔离：不直接使用输入全局变量")]),t._v(" "),n("li",[t._v("找个可靠的人来帮你审查代码：出门靠朋友？")])]),t._v(" "),n("h3",{attrs:{id:"感悟：道高一尺魔高一丈"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：道高一尺魔高一丈"}},[t._v("#")]),t._v(" 感悟：道高一尺魔高一丈")]),t._v(" "),n("ul",[n("li",[t._v("转义字符伪装注入更可怕，"),n("code",[t._v("\\")]),t._v("、"),n("code",[t._v("--")]),t._v("、"),n("code",[t._v("/* */")]),t._v("都能被注入！")]),t._v(" "),n("li",[t._v("善用语言、扩展、模块自带的防注入工具\n"),n("ul",[n("li",[t._v("PHP："),n("code",[t._v("mysql_real_escape_string()")]),t._v("、"),n("code",[t._v("stripslashes()")]),t._v("、"),n("code",[t._v("magic_quotes_gpc()")])]),t._v(" "),n("li",[t._v("node-mysql："),n("code",[t._v("escape()")]),t._v("、"),n("code",[t._v("escapeId()")]),t._v("、"),n("code",[t._v("format()")])])])]),t._v(" "),n("li",[t._v("可接合SQL占位符拼接SQL语句")]),t._v(" "),n("li",[t._v("提高防范意识，多检查，多测试")])]),t._v(" "),n("h2",{attrs:{id:"二十二、伪键洁癖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十二、伪键洁癖"}},[t._v("#")]),t._v(" 二十二、伪键洁癖")]),t._v(" "),n("h3",{attrs:{id:"目标：整理数据（guid）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：整理数据（guid）"}},[t._v("#")]),t._v(" 目标：整理数据（GUID）")]),t._v(" "),n("p",[t._v("使数据编号连续。")]),t._v(" "),n("h3",{attrs:{id:"反模式：填充角落"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：填充角落"}},[t._v("#")]),t._v(" 反模式：填充角落")]),t._v(" "),n("p",[t._v("随着数据库的使用，有些行会被删除。比如原来连续编号的1234，3被删除了，变成124。\n强迫症患者新增记录的时候会找出缺失的3，然后把新记录填充进去，编号为3。\n或者当编号3被删除时强制把编号4更新为编号3。由于编号已被各种关联，引起一堆问题。")]),t._v(" "),n("h3",{attrs:{id:"解决方案：克服心理障碍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：克服心理障碍"}},[t._v("#")]),t._v(" 解决方案：克服心理障碍")]),t._v(" "),n("ul",[n("li",[t._v("使用"),n("code",[t._v("ROW_NUMBER()")]),t._v("定义行号")]),t._v(" "),n("li",[t._v("使用"),n("code",[t._v("GUID")])])]),t._v(" "),n("h3",{attrs:{id:"感悟：我觉得可以抢救一下"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：我觉得可以抢救一下"}},[t._v("#")]),t._v(" 感悟：我觉得可以抢救一下")]),t._v(" "),n("p",[t._v("早发现，早治疗，正确面对，主动配合，还你健康人生。\n杭州七院24小时心理援助热线："),n("code",[t._v("0571-85029595")]),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"二十三、非礼勿视"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十三、非礼勿视"}},[t._v("#")]),t._v(" 二十三、非礼勿视")]),t._v(" "),n("h3",{attrs:{id:"目标：写更少的代码（debug）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：写更少的代码（debug）"}},[t._v("#")]),t._v(" 目标：写更少的代码（Debug）")]),t._v(" "),n("p",[t._v("用更少的代码来提高代码的优雅程度？我怎么觉得是：如何正确展现错误并快速的排除错误呢？")]),t._v(" "),n("h3",{attrs:{id:"反模式：无米之炊"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：无米之炊"}},[t._v("#")]),t._v(" 反模式：无米之炊")]),t._v(" "),n("ul",[n("li",[t._v("用户界面没有错误提示，用户一脸茫然")]),t._v(" "),n("li",[t._v("难以被发现的代码错误，码农一脸懵逼")])]),t._v(" "),n("h3",{attrs:{id:"解决方案：优雅的从错误中恢复"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：优雅的从错误中恢复"}},[t._v("#")]),t._v(" 解决方案：优雅的从错误中恢复")]),t._v(" "),n("ul",[n("li",[t._v("使用捕捉机制"),n("code",[t._v("try...catch...")])]),t._v(" "),n("li",[t._v("利用日志机制调试")])]),t._v(" "),n("h3",{attrs:{id:"感悟：排错是基本功"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：排错是基本功"}},[t._v("#")]),t._v(" 感悟：排错是基本功")]),t._v(" "),n("p",[t._v("出错了，要给用户必要的明确的提示，给码农完整的详尽的提示。")]),t._v(" "),n("h2",{attrs:{id:"二十四、外交豁免权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十四、外交豁免权"}},[t._v("#")]),t._v(" 二十四、外交豁免权")]),t._v(" "),n("h3",{attrs:{id:"目标：采用最佳实践（project-management）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：采用最佳实践（project-management）"}},[t._v("#")]),t._v(" 目标：采用最佳实践（Project Management）")]),t._v(" "),n("ul",[n("li",[t._v("版本控制")]),t._v(" "),n("li",[t._v("自动化测试")]),t._v(" "),n("li",[t._v("文档")])]),t._v(" "),n("h3",{attrs:{id:"反模式：将sql视为二等公民"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：将sql视为二等公民"}},[t._v("#")]),t._v(" 反模式：将SQL视为二等公民")]),t._v(" "),n("p",[t._v("数据开发工作未被软件工程最佳实践纳入。")]),t._v(" "),n("h3",{attrs:{id:"解决方案：建立一个质量至上的文化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：建立一个质量至上的文化"}},[t._v("#")]),t._v(" 解决方案：建立一个质量至上的文化")]),t._v(" "),n("p",[t._v("将数据库设计开发工作纳入软件工程管理范畴，并提供最佳实践。")]),t._v(" "),n("h3",{attrs:{id:"感悟：数据为王"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：数据为王"}},[t._v("#")]),t._v(" 感悟：数据为王")]),t._v(" "),n("ul",[n("li",[t._v("谁敢说SQL是二等公民？马爸爸说了，接下是DT（Data Technology）时代。")]),t._v(" "),n("li",[t._v("软件工程最佳实践又何止版本、测试、文档三方面。")])]),t._v(" "),n("h2",{attrs:{id:"二十五、魔豆"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二十五、魔豆"}},[t._v("#")]),t._v(" 二十五、魔豆")]),t._v(" "),n("h3",{attrs:{id:"目标：简化mvc模型（design-pattern）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目标：简化mvc模型（design-pattern）"}},[t._v("#")]),t._v(" 目标：简化MVC模型（Design pattern）")]),t._v(" "),n("p",[t._v("低耦合、高内聚。清晰的领会模型的意义。")]),t._v(" "),n("h3",{attrs:{id:"反模式：模型仅仅是活动记录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#反模式：模型仅仅是活动记录"}},[t._v("#")]),t._v(" 反模式：模型仅仅是活动记录")]),t._v(" "),n("p",[t._v("一个领域模型（Model）对应一个数据库表（Table），导致大量代码别复制粘贴，而不能很好的被复用。高耦合，低内聚，业务逻辑混乱。\n其实这是对"),n("code",[t._v("Active Record")]),t._v("理解的问题，也属于设计模式问题，一个领域模型对应一个具体表还一个业务逻辑模型的问题。")]),t._v(" "),n("h3",{attrs:{id:"解决方案：模型包含活动记录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决方案：模型包含活动记录"}},[t._v("#")]),t._v(" 解决方案：模型包含活动记录")]),t._v(" "),n("p",[t._v("原著推荐《领域驱动设计：软件核心复杂性应对之道》，模型设计围绕程序逻辑，而不是数据库层面，将模型和表解耦，业务逻辑与实体表分层。")]),t._v(" "),n("h3",{attrs:{id:"感悟：运用之道，存乎一心"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#感悟：运用之道，存乎一心"}},[t._v("#")]),t._v(" 感悟：运用之道，存乎一心")]),t._v(" "),n("p",[t._v("深入理解设计模式，并将它正确的运用在开发过程中。")]),t._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("思维方式")]),t._v(" ： SQL语法是基础是手段，思维方式是指导思想，如果思维误入歧途，再好的手段也只能是南辕北辙；")]),t._v(" "),n("li",[n("strong",[t._v("数据结构")]),t._v(" ：虽然原著对“多态关联”和“可变属性”等数据结构做了阐述并解决，但有意无意中也在犯着同样的错误，透彻的分析并理解数据结构非常重要；")]),t._v(" "),n("li",[n("strong",[t._v("第一范式")]),t._v(" ：原著对于第一范式（1NF）的理解还是比较透彻的，大约用了三章阐述类似的问题，略啰嗦；")]),t._v(" "),n("li",[n("strong",[t._v("下划线命名法")]),t._v(" ：原著中采用驼峰命名法，其实在大多数数据库系统中大小写不敏感，ProductBugs和PRODUCTBUGS并没有什么区别，所以建议命名为：product_bugs；")]),t._v(" "),n("li",[n("strong",[t._v("约定大于配置")]),t._v(" ：原著中所有的ID，都使用了“表名（单数）_id”，并不符合“约定大于配置”的现代开发理念。主表ID还是建议用id，引用表外键建议用“主表（单数）_id”；")]),t._v(" "),n("li",[n("strong",[t._v("分布式分层部署")]),t._v(" ：原著中的实践环境并没有考虑到分布式及分层式部署，特别是"),n("code",[t._v("BLOB")]),t._v("格式存储文件，这样的设计相对已经很落后了，请大家借鉴着阅读，以防踩坑。")])]),t._v(" "),n("h2",{attrs:{id:"声明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#声明"}},[t._v("#")]),t._v(" 声明")]),t._v(" "),n("ul",[n("li",[t._v("版权所有，未经作者同意不得用于商业用途。")]),t._v(" "),n("li",[t._v("欢迎转载，敬请保留作者信息。")])]),t._v(" "),n("blockquote",[n("p",[t._v("方跃明\n2018-05-31")])])])}),[],!1,null,null,null);s.default=e.exports}}]);